# 商城页面401错误修复说明

## 问题描述

在打开商城页面时，会出现以下错误：
- GET http://localhost:3003/exchange/list?page=1&size=10 401 (Unauthorized)
- GET http://localhost:3003/point/balance 401 (Unauthorized)

错误信息显示："未授权或Token已过期，请重新登录"

## 问题分析

经过代码分析，发现问题的根本原因是：

1. **接口权限配置错误**：在`WebSecurityConfig.java`中，`/point/balance`和`/exchange/list`这两个接口被错误地配置为公开访问（`.permitAll()`），但实际上它们需要用户认证才能访问。

2. **用户ID获取方式不一致**：后端控制器使用`@RequestHeader("X-User-Id")`来获取用户ID，但这些接口被设置为公开访问，导致JWT认证过滤器不会执行，用户ID无法从SecurityContext中获取。

## 修复方案

### 1. 修改WebSecurityConfig.java

将`/point/balance`和`/exchange/list`从公开访问列表中移除，改为需要认证的接口：

```java
// 从公开访问列表中移除
// "/point/balance",
// "/point/history",
// "/exchange/list",
```

### 2. 修改PointController.java

将用户ID获取方式从`@RequestHeader("X-User-Id")`改为从SecurityContext中获取：

```java
@GetMapping("/balance")
public Result<Integer> getBalance() {
    Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();
    Long userId = (principal instanceof Long) ? (Long) principal : null;
    
    if (userId == null) {
        return Result.error("用户未登录");
    }
    
    Integer balance = pointService.getUserPoints(userId);
    return Result.success(balance);
}
```

### 3. 修改ExchangeRecordController.java

将`/exchange/list`和`/exchange/create`接口的用户ID获取方式改为从SecurityContext中获取：

```java
@GetMapping("/list")
public Result<Map<String, Object>> getUserExchanges(
        @RequestParam(defaultValue = "1") Integer page,
        @RequestParam(defaultValue = "10") Integer size) {
    Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();
    Long userId = (principal instanceof Long) ? (Long) principal : null;
    
    if (userId == null) {
        return Result.error("用户未登录");
    }
    
    Map<String, Object> exchanges = exchangeRecordService.getUserExchanges(userId, page, size);
    return Result.success(exchanges);
}

@PostMapping("/create")
public Result<String> createExchange(@RequestBody ExchangeRequest request) {
    Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();
    Long userId = (principal instanceof Long) ? (Long) principal : null;
    
    if (userId == null) {
        return Result.error("用户未登录");
    }
    
    boolean success = exchangeRecordService.createExchange(
        userId, 
        request.getProductId(), 
        request.getAddress(), 
        request.getPhone(), 
        request.getRemark()
    );
    
    if (success) {
        return Result.success("兑换成功");
    }
    return Result.error("兑换失败，请检查积分或库存");
}
```

### 4. 优化Mall.vue错误处理

在Mall.vue中添加了更完善的错误处理逻辑：

- 检查响应状态码为401时，清除登录状态并显示提示信息
- 在catch块中检查是否为401错误，避免重复处理
- 在token过期时自动跳转到登录页

## 修复效果

修复后，商城页面的功能将正常工作：

1. **用户积分显示**：已登录用户可以正常查看自己的积分余额
2. **兑换记录显示**：已登录用户可以正常查看自己的兑换记录
3. **商品兑换功能**：已登录用户可以正常兑换商品
4. **token过期处理**：当token过期时，会自动清除登录状态并跳转到登录页

## 技术要点

1. **JWT认证流程**：
   - 用户登录后，后端生成JWT token并返回给前端
   - 前端将token存储在localStorage中
   - 每次请求时，axios拦截器会自动在请求头中添加Authorization: Bearer {token}
   - 后端的JwtAuthenticationFilter会验证token的有效性
   - 验证通过后，将用户ID设置到SecurityContext中

2. **接口权限控制**：
   - 需要认证的接口：需要在请求头中携带有效的JWT token
   - 公开接口：不需要认证，任何人都可以访问
   - 管理员接口：需要管理员角色才能访问

3. **错误处理**：
   - 401 Unauthorized：token无效或过期，需要重新登录
   - 403 Forbidden：权限不足，无法访问该资源
   - 其他错误：根据具体业务逻辑处理

## 注意事项

1. 确保后端服务已重新启动，使配置生效
2. 如果用户token已过期，需要重新登录获取新的token
3. 前端代码修改后，需要重新编译或刷新页面
