# 摄友圈社区系统 - 注册/登录功能修复说明

## 修复概述

本次修复主要针对摄友圈社区系统的注册/登录功能，确保用户能够正常注册、登录并获取JWT令牌。

## 修复内容

### 1. 后端修复

#### 1.1 UserController.java
- **问题**: `extractUserIdFromToken`方法只是简单返回1L用于测试，没有实际解析token
- **修复**: 
  - 添加了`JwtUtils`的import语句
  - 修复了`extractUserIdFromToken`方法，使用`JwtUtils`解析token获取真实的用户ID
  - 添加了异常处理，当token无效时抛出明确的异常

#### 1.2 JWT配置检查
- **检查结果**: application.yml中的JWT配置已经正确
  - `jwt.secret`: shengyouquan-secret-key-2024-12-25
  - `jwt.expiration`: 86400000 (24小时)
  - `jwt.token-prefix`: Bearer

#### 1.3 UserService.java
- **检查结果**: 密码加密和校验逻辑已经正确实现
  - 使用`BCryptPasswordEncoder`进行密码加密
  - 使用`passwordEncoder.matches()`进行密码校验
  - 注册时验证密码一致性
  - 登录时验证用户状态

#### 1.4 JWT工具类 (JwtUtils.java)
- **检查结果**: JWT工具类已经完整实现
  - 生成token
  - 解析token
  - 验证token
  - 提取用户信息

### 2. 前端修复

#### 2.1 前端请求封装 (main.js)
- **检查结果**: axios配置已经正确
  - 基础URL: `http://localhost:8081/api/v1`
  - 请求拦截器：自动添加Authorization头
  - 响应拦截器：处理401未授权错误

#### 2.2 登录页面 (Login.vue)
- **检查结果**: 登录逻辑已经完整实现
  - 表单验证
  - 登录请求
  - token存储
  - 错误处理

#### 2.3 注册页面 (Register.vue)
- **检查结果**: 注册逻辑已经完整实现
  - 表单验证
  - 用户名/邮箱检查
  - 注册请求
  - 错误处理

#### 2.4 CORS配置 (WebSecurityConfig.java)
- **检查结果**: CORS配置已经正确
  - 允许的源：http://localhost:3002, http://localhost:3000, http://localhost:5173
  - 允许的方法：GET, POST, PUT, DELETE, OPTIONS
  - 允许的头：Authorization, Content-Type, x-user-id等
  - 允许携带凭证

#### 2.5 Vite代理配置 (vite.config.js)
- **检查结果**: 代理配置已经正确
  - 代理路径：/api/v1
  - 目标地址：http://localhost:8081

## 验证步骤

### 1. 准备数据库
确保MySQL数据库已创建，并执行以下SQL：
```sql
CREATE DATABASE IF NOT EXISTS shengyouquan;
USE shengyouquan;
-- 执行项目中的schema.sql文件
```

### 2. 启动后端服务
```bash
cd 摄友圈社区系统/backend
mvn spring-boot:run
```

### 3. 启动前端服务
```bash
cd 摄友圈社区系统/frontend
npm run dev
```

### 4. 测试注册接口
```bash
curl -X POST http://localhost:8081/api/v1/user/register \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","email":"test@example.com","password":"123456","confirmPassword":"123456"}'
```

**预期返回**:
```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "id": 1,
    "username": "testuser",
    "email": "test@example.com",
    "nickname": "testuser",
    "role": "user",
    "status": 1,
    "points": 10,
    "registerTime": "2024-12-25 10:00:00"
  }
}
```

### 5. 测试登录接口
```bash
curl -X POST http://localhost:8081/api/v1/user/login \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"123456"}'
```

**预期返回**:
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzUxMiJ9...",
    "expiresIn": 86400,
    "userInfo": {
      "id": 1,
      "username": "testuser",
      "email": "test@example.com",
      "nickname": "testuser",
      "role": "user",
      "status": 1,
      "points": 10,
      "registerTime": "2024-12-25 10:00:00",
      "lastLoginTime": "2024-12-25 10:05:00"
    }
  }
}
```

### 6. 前端验证
1. 访问 http://localhost:3003
2. 点击"立即注册"，填写注册表单
3. 注册成功后，跳转到登录页面
4. 输入用户名和密码登录
5. 登录成功后，跳转到首页
6. 检查浏览器开发者工具的Network面板，确认token已存储

## 常见问题排查

### 1. 注册失败，返回500错误
- **可能原因**: 数据库连接失败
- **解决方法**: 检查application.yml中的数据库配置，确保MySQL服务已启动

### 2. 登录失败，返回"用户名或密码错误"
- **可能原因**: 密码未正确加密或校验
- **解决方法**: 
  - 检查UserService中的passwordEncoder是否正确注入
  - 确认数据库中的密码是加密后的格式

### 3. 登录成功但无法获取token
- **可能原因**: JWT配置错误
- **解决方法**: 
  - 检查application.yml中的jwt配置
  - 查看后端日志，确认token生成过程

### 4. 前端跨域错误
- **可能原因**: CORS配置不正确
- **解决方法**: 
  - 检查WebSecurityConfig中的CORS配置
  - 确认前端vite.config.js中的代理配置

### 5. Token验证失败
- **可能原因**: token格式错误或过期
- **解决方法**: 
  - 检查前端是否正确添加Bearer前缀
  - 确认token未过期（默认24小时）

## 修复总结

本次修复主要解决了以下问题：

1. **JWT token解析问题**: 修复了UserController中token解析逻辑，确保能正确获取用户ID
2. **异常处理优化**: 添加了更详细的异常处理，便于问题排查
3. **代码完整性**: 确保所有必要的import语句都已添加
4. **配置验证**: 验证了所有配置文件的正确性

修复后的系统应该能够正常处理用户注册、登录，并正确生成和验证JWT令牌。

## 测试脚本

项目根目录下提供了`测试注册登录.bat`脚本，可以一键测试注册和登录功能。

## 注意事项

1. 生产环境中，建议将JWT密钥配置在环境变量中，不要硬编码在配置文件中
2. 建议添加更多的输入验证和安全措施
3. 建议添加日志记录，便于问题排查
4. 建议添加限流机制，防止恶意注册/登录尝试
