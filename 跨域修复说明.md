# 跨域（CORS）修复说明

## 问题描述
前端运行在 `http://192.168.226.1:3003`，后端运行在 `http://localhost:8082`，导致浏览器出现CORS跨域错误，无法正常注册和登录。

## 修复方案

### 1. 更新CorsConfig.java
**文件位置**: `backend/src/main/java/com/shengyouquan/config/CorsConfig.java`

**主要更改**:
- 在允许的源列表中添加了 `http://192.168.226.1:3003`
- 确保CORS配置对所有接口生效 (`/**`)

**关键配置**:
```java
config.setAllowedOrigins(Arrays.asList(
    "http://localhost:3003",
    "http://localhost:3004",
    "http://localhost:3002",
    "http://localhost:3000",
    "http://localhost:5173",
    "http://127.0.0.1:3003",
    "http://127.0.0.1:3004",
    "http://127.0.0.1:3002",
    "http://127.0.0.1:3000",
    "http://127.0.0.1:5173",
    "http://192.168.226.1:3003"  // 前端实际运行地址
));
```

### 2. 更新WebSecurityConfig.java
**文件位置**: `backend/src/main/java/com/shengyouquan/config/WebSecurityConfig.java`

**主要更改**:
- 在Spring Security的CORS配置中添加了 `http://192.168.226.1:3003`
- 确保Spring Security的CORS配置与CorsConfig保持一致

**关键配置**:
```java
configuration.setAllowedOrigins(Arrays.asList(
    "http://localhost:3003",
    "http://localhost:3004",
    "http://localhost:3002",
    "http://localhost:3000",
    "http://localhost:5173",
    "http://127.0.0.1:3003",
    "http://127.0.0.1:3004",
    "http://127.0.0.1:3002",
    "http://127.0.0.1:3000",
    "http://127.0.0.1:5173",
    "http://192.168.226.1:3003"  // 前端实际运行地址
));
```

## 配置说明

### CORS配置参数
1. **allowedOrigins**: 允许访问的前端源地址
2. **allowCredentials**: 允许携带凭证（Cookie、Authorization头）
3. **allowedMethods**: 允许的HTTP方法（GET、POST、PUT、DELETE、OPTIONS）
4. **allowedHeaders**: 允许的请求头
5. **exposedHeaders**: 暴露给前端的响应头
6. **maxAge**: 预检请求缓存时间（秒）

### 预检请求（OPTIONS）
浏览器在发送跨域请求前会先发送OPTIONS预检请求，后端必须：
1. 正确处理OPTIONS请求
2. 返回200状态码
3. 包含正确的CORS响应头

## 测试方法

### 方法1：使用测试脚本
```bash
# 运行测试脚本
测试注册登录CORS修复.bat
```

### 方法2：手动测试
1. 启动后端服务：
   ```bash
   cd backend
   java -jar target/shengyouquan-backend-1.0.0.jar
   ```

2. 启动前端服务：
   ```bash
   cd frontend
   npm run dev
   ```

3. 打开浏览器访问：`http://localhost:3003`

4. 尝试注册新用户

5. 尝试登录

6. 检查浏览器控制台是否有CORS错误

## 验证要点

### 1. OPTIONS预检请求
- 查看浏览器Network面板中的OPTIONS请求
- 确认响应头包含：
  - `Access-Control-Allow-Origin: http://192.168.226.1:3003`
  - `Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS`
  - `Access-Control-Allow-Credentials: true`

### 2. 实际请求
- 查看POST /user/register和POST /user/login请求
- 确认响应头包含CORS允许头
- 确认请求成功，返回正确数据

### 3. 前端配置
- 确认前端axios配置了 `withCredentials: true`
- 确认前端baseURL配置正确

## 注意事项

1. **生产环境安全**：
   - 不要使用通配符 `*` 作为allowedOrigins
   - 建议指定具体的前端域名
   - 考虑使用环境变量配置允许的源

2. **CORS配置优先级**：
   - Spring Security的CORS配置优先级高于CorsConfig
   - 确保两个配置保持一致

3. **浏览器缓存**：
   - 修改CORS配置后，建议清除浏览器缓存或使用无痕模式测试
   - 预检请求结果会被浏览器缓存，可能需要等待缓存过期

4. **网络环境**：
   - 确保前端和后端在同一网络环境下
   - 确保防火墙没有阻止跨域请求

## 相关文件

- `backend/src/main/java/com/shengyouquan/config/CorsConfig.java`
- `backend/src/main/java/com/shengyouquan/config/WebSecurityConfig.java`
- `frontend/src/main.js`
- `frontend/vite.config.js`

## 测试脚本

- `测试注册登录CORS修复.bat` - 自动启动服务并提供测试指引

## 修复时间

2026年2月7日

## 修复人员

摄友圈开发团队
